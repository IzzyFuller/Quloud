name: Mutation Testing

on:
  schedule:
    - cron: '0 2 * * 0'  # Weekly Sunday 2am UTC
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - 'src/quloud/core/**'
      - 'tests/**'

jobs:
  mutation-test:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
      - run: uv python install 3.13
      - run: uv sync --dev

      - name: Run mutation tests
        id: mutate
        run: |
          # Capture output to parse results
          make mutate 2>&1 | tee mutmut_output.txt
          # Extract final status line (e.g., "217/217  ðŸŽ‰ 216 ðŸ«¥ 0  â° 0 ...")
          tail -5 mutmut_output.txt

      - name: Calculate mutation score
        id: score
        run: |
          # Parse the emoji output from mutmut run
          # Format: "217/217  ðŸŽ‰ 216 ðŸ«¥ 0  â° 0  ðŸ¤” 0  ðŸ™ 1  ðŸ”‡ 0"
          FINAL_LINE=$(grep -E "ðŸŽ‰.*ðŸ«¥" mutmut_output.txt | tail -1)
          echo "Final line: $FINAL_LINE"

          # Extract counts using grep -oE
          KILLED=$(echo "$FINAL_LINE" | grep -oE "ðŸŽ‰ [0-9]+" | grep -oE "[0-9]+" || echo 0)
          SURVIVED=$(echo "$FINAL_LINE" | grep -oE "ðŸ«¥ [0-9]+" | grep -oE "[0-9]+" || echo 0)
          TIMEOUT=$(echo "$FINAL_LINE" | grep -oE "â° [0-9]+" | grep -oE "[0-9]+" || echo 0)

          # Killed includes timeouts
          KILLED=$((KILLED + TIMEOUT))
          TOTAL=$((KILLED + SURVIVED))

          echo "Killed: $KILLED, Survived: $SURVIVED, Total: $TOTAL"

          if [ "$TOTAL" -gt 0 ]; then
            SCORE=$((KILLED * 100 / TOTAL))
          else
            SCORE=100
          fi

          # Determine color based on score
          if [ "$SCORE" -ge 80 ]; then
            COLOR="brightgreen"
          elif [ "$SCORE" -ge 60 ]; then
            COLOR="yellow"
          else
            COLOR="red"
          fi

          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "color=$COLOR" >> $GITHUB_OUTPUT

          echo "Mutation Score: $SCORE% ($KILLED/$TOTAL mutants killed)"

      - name: Update badge JSON
        run: |
          mkdir -p .github/badges
          cat > .github/badges/mutation.json << EOF
          {
            "schemaVersion": 1,
            "label": "mutation score",
            "message": "${{ steps.score.outputs.score }}%",
            "color": "${{ steps.score.outputs.color }}"
          }
          EOF

      - name: Commit badge
        continue-on-error: true  # Don't fail workflow if branch protection blocks push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .github/badges/mutation.json
          git diff --staged --quiet || git commit -m "Update mutation score badge: ${{ steps.score.outputs.score }}%"
          git push || echo "Push failed (likely branch protection) - badge not updated"
